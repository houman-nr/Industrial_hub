<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link rel="stylesheet" href="{% static 'css/bootstrap-icons.min.css' %}">
    <link rel="stylesheet" href="{% static 'css/bootstrap.min.css' %}">
    <link rel="stylesheet" href="{% static 'css/styles.css' %}">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.min.css">
    <title>ساخت تور</title>
</head>
<body>
    <ul class="formCircles">
        <li></li>
        <li></li>
        <li></li>
        <li></li>
        <li></li>
    </ul>

    <div class="homePageBody">
        <div class="tourCreateContainer">
            <header>
                <h2>ساخت تور</h2>
                <h6>توری برای نمایش دادن هرچه بهتر شرکت شما به مشتری</h6>
            </header>

            <!-- Django Form for Creating Tour -->
            <form id="uploadForm" action="{% url 'create_tour' %}" method="post" enctype="multipart/form-data">
                {% csrf_token %}
                
                <!-- Profile Image Upload -->
                <div class="imageSection">
                    <div class="imageUploadSection">
                        <label for="profileImageUpload">تصویر پروفایل خود را آپلود کنید:</label>
                        <input type="file" id="profileImageUpload" name="profile_image" accept="image/*">
                    </div>

                    <div class="uploadedImagesSection">
                        <h4>تصویر پروفایل آپلود شده</h4>
                        <ul class="file-list" id="profileImageList">
                            <li>-----</li>
                        </ul>
                    </div>
                </div>

                <!-- Image Upload -->
                <div class="imageSection">
                    <div class="imageUploadSection">
                        <label for="imageUpload">تصاویر خود را آپلود کنید:</label>
                        <input type="file" id="imageUpload" name="images" accept="image/*" multiple>
                    </div>

                    <div class="uploadedImagesSection">
                        <h4>تصاویر آپلود شده</h4>
                        <ul class="file-list" id="imageList">
                            <li>-----</li>
                        </ul>
                    </div>
                </div>

                <!-- Video Upload -->
                <div class="videoSection">
                    <div class="videoUploadSection">
                        <label for="videoUpload">ویدئوهای خود را آپلود کنید:</label>
                        <input type="file" id="videoUpload" name="videos" accept="video/*" multiple>
                    </div>

                    <div class="uploadedVideosSection">
                        <h4>ویدئو های آپلود شده</h4>
                        <ul class="file-list" id="videoList">
                            <li>-----</li>
                        </ul>
                    </div>
                </div>

                <!-- Description -->
                <div class="descriptionSection">
                    <label for="description"><h5>توضیحات:</h5></label>
                    <textarea id="description" name="description" rows="4" cols="50" placeholder="توضیحاتی در مورد شرکت....." required></textarea><br><br>
                </div>

                <input type="submit" value="ایجاد تور">
            </form>

            <script>
                // JavaScript to handle previewing and removing images/videos
                const profileImageInput = document.getElementById('profileImageUpload');
                const imageInput = document.getElementById('imageUpload');
                const videoInput = document.getElementById('videoUpload');
                const profileImageList = document.getElementById('profileImageList');
                const imageList = document.getElementById('imageList');
                const videoList = document.getElementById('videoList');
                const uploadForm = document.getElementById('uploadForm');

                let profileImage = null;
                let imageArray = [];
                let videoArray = [];

                profileImageInput.addEventListener('change', handleProfileImageSelect);
                imageInput.addEventListener('change', handleImageSelect);
                videoInput.addEventListener('change', handleVideoSelect);
                profileImageList.addEventListener('click', handleProfileImageRemove);
                imageList.addEventListener('click', handleFileRemove);
                videoList.addEventListener('click', handleFileRemove);

                function handleProfileImageSelect(event) {
                    const file = event.target.files[0];
                    profileImage = file;
                    renderProfileImage(profileImage, profileImageList);
                }

                function handleImageSelect(event) {
                    const files = Array.from(event.target.files);
                    imageArray = imageArray.concat(files);
                    renderFileList(imageArray, imageList, 'image');
                }

                function handleVideoSelect(event) {
                    const files = Array.from(event.target.files);
                    videoArray = videoArray.concat(files);
                    renderFileList(videoArray, videoList, 'video');
                }

                function handleProfileImageRemove(event) {
                    if (event.target.tagName === 'BUTTON') {
                        profileImage = null;
                        renderProfileImage(null, profileImageList);
                    }
                }

                function handleFileRemove(event) {
                    if (event.target.tagName === 'BUTTON') {
                        const index = event.target.getAttribute('data-index');
                        const type = event.target.getAttribute('data-type');
                        if (type === 'image') {
                            imageArray.splice(index, 1);
                            renderFileList(imageArray, imageList, 'image');
                        } else if (type === 'video') {
                            videoArray.splice(index, 1);
                            renderFileList(videoArray, videoList, 'video');
                        }
                    }
                }

                function renderProfileImage(file, fileList) {
                    fileList.innerHTML = '';
                    if (file) {
                        const listItem = document.createElement('li');
                        listItem.classList.add('file-item');

                        const filePreview = document.createElement('img');
                        filePreview.src = URL.createObjectURL(file);
                        filePreview.alt = 'Profile Image';

                        listItem.innerHTML = `
                            <span>${file.name}</span>
                            <button type="button" data-type="profile"><i class="bi bi-x-lg"></i></button>
                        `;
                        listItem.insertBefore(filePreview, listItem.firstChild);
                        fileList.appendChild(listItem);
                    } else {
                        const listItem = document.createElement('li');
                        listItem.textContent = '-----';
                        fileList.appendChild(listItem);
                    }
                }

                function renderFileList(fileArray, fileList, type) {
                    fileList.innerHTML = '';
                    fileArray.forEach((file, index) => {
                        const listItem = document.createElement('li');
                        listItem.classList.add('file-item');

                        const filePreview = document.createElement('img');
                        if (type === 'image') {
                            filePreview.src = URL.createObjectURL(file);
                        } else if (type === 'video') {
                            filePreview.src = 'path_to_static_video_thumbnail_image'; // Replace with the path to your static image
                        }

                        listItem.innerHTML = `
                            <span>${file.name}</span>
                            <button type="button" data-index="${index}" data-type="${type}"><i class="bi bi-x-lg"></i></button>
                        `;
                        listItem.insertBefore(filePreview, listItem.firstChild);
                        fileList.appendChild(listItem);
                    });
                }

                uploadForm.addEventListener('submit', (event) => {
                    event.preventDefault();

                    const formData = new FormData(uploadForm);
                    if (profileImage) {
                        formData.append('profile_image', profileImage);
                    }
                    imageArray.forEach(file => {
                        formData.append('images[]', file);
                    });
                    videoArray.forEach(file => {
                        formData.append('videos[]', file);
                    });

                    fetch('{% url 'create_tour' %}', {
                        method: 'POST',
                        body: formData
                    })
                    .then(response => response.json())
                    .then(data => {
                        alert('Files uploaded successfully!');
                    })
                    .catch(error => {
                        console.error('Error:', error);
                    });
                });
            </script>
        </div>
    </div>
</body>
<script src="{% static 'js/scripts.js' %}"></script>
</html>
